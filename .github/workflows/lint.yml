name: Lint

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Lint bash scripts
        run: |
          shellcheck -s bash worktree.sh
          shellcheck -s bash completions.bash
          shellcheck -s bash setup.sh

  zsh-syntax:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install zsh
        run: sudo apt-get install -y zsh

      - name: Check zsh syntax
        run: |
          zsh -n worktree.sh
          zsh -n completions.zsh

  fish-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install fish
        run: |
          sudo apt-add-repository -y ppa:fish-shell/release-3
          sudo apt-get update
          sudo apt-get install -y fish

      - name: Check fish syntax
        run: |
          fish -n worktree.fish
          fish -n completions.fish

  powershell-lint:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Lint PowerShell scripts
        shell: pwsh
        run: |
          $results = @()
          $results += Invoke-ScriptAnalyzer -Path worktree.ps1 -Severity Error,Warning
          $results += Invoke-ScriptAnalyzer -Path completions.ps1 -Severity Error,Warning
          $results += Invoke-ScriptAnalyzer -Path setup.ps1 -Severity Error,Warning
          
          if ($results) {
            $results | Format-Table -AutoSize
            exit 1
          }
          Write-Host "All PowerShell scripts passed linting" -ForegroundColor Green

      - name: Check PowerShell syntax
        shell: pwsh
        run: |
          $files = @('worktree.ps1', 'completions.ps1', 'setup.ps1')
          foreach ($file in $files) {
            $errors = $null
            [System.Management.Automation.Language.Parser]::ParseFile($file, [ref]$null, [ref]$errors) | Out-Null
            if ($errors) {
              Write-Host "Syntax errors in $file`:" -ForegroundColor Red
              $errors | ForEach-Object { Write-Host "  $_" }
              exit 1
            }
            Write-Host "âœ“ $file syntax OK" -ForegroundColor Green
          }
